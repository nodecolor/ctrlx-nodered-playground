name: snapbuild
on:
  workflow_dispatch:
jobs:
  build-stable:
    runs-on: ubuntu-latest
    
    # Let's build for amd64 and arm64 see crtlx requirements
    strategy:
      matrix:
        architecture:
        - linux/amd64
        - linux/arm64
    steps:
    # Checkout the code
    - uses: actions/checkout@v2

    # Do the build!
    - id: build
      run: |
        sudo grub-mkconfig -o /boot/grub/grub.cfg
        sudo grub2-mkconfig -o /boot/grub/grub.cfg
        sudo update-grub
        sudo grubby --update-kernel=ALL --args="systemd.unified_cgroup_hierarchy=0"
        # Enable docker daemon support for --platform parameter
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json > /dev/null
        sudo systemctl restart docker

        # Configure qemu-user-static
        sudo docker run --rm --tty --privileged \
          --security-opt apparmor:unconfined \
          --cap-add SYS_ADMIN \
          multiarch/qemu-user-static --reset -p yes

        # Run snapcraft
        sudo docker run --rm --tty --privileged\
          --security-opt apparmor:unconfined \
          --cap-add SYS_ADMIN \
          --device /dev/fuse \
          --volume /sys \
          --volume /sys/fs/cgroup:/sys/fs/cgroup:ro \
          --volume $GITHUB_WORKSPACE:$GITHUB_WORKSPACE \
          --workdir $GITHUB_WORKSPACE \
          --platform "${{ matrix.architecture }}" \
          --env PLAYTEST="${{ matrix.playtest }}" \
          diddledani/snapcraft:core18

        echo ::set-output name=snap::$(find $GITHUB_WORKSPACE -maxdepth 1 -type f -name "*.snap" | head -n1)
    -
      name: Upload
      uses: actions/upload-artifact@v3
      with:
          name: snaps
          path: ${{steps.build.outputs.path-snap}}
